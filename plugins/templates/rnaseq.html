{% extends 'appbuilder/baselayout.html' %}
{% from 'airflow/_messages.html' import show_message %}

{% block page_title -%}
  {% if title is defined -%}
    {{ title }} - {{ appbuilder.app_name }}
  {% else -%}
    {{ appbuilder.app_name }}
  {% endif%}
{% endblock %}

{% block head_meta %}
  {{ super() }}
  {% if scheduler_job is defined and scheduler_job.is_alive() %}
    <meta name="is_scheduler_running" content="True">
  {% endif %}
{% endblock %}

{% block head_css %}
  {{ super() }}
  {% if not appbuilder.app_theme %}
    <link rel="stylesheet" type="text/css" href="{{ url_for_asset('airflowDefaultTheme.css') }}">
  {% endif %}
  <link rel="stylesheet" type="text/css" href="{{ url_for_asset('materialIcons.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for_asset('main.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for_asset('loadingDots.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for_asset('bootstrap-datetimepicker.min.css') }}">
  <style type="text/css">
    {% for state, state_color in state_color_mapping.items() %}
      span.{{state}} {
        background-color: {{state_color}};
      }
    {% endfor %}
  </style>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='pin_32.png') }}">
{% endblock %}

{% block messages %}

<br><br>
<h4>Sample Selection</h4>
<p>================</p>
<br>

<!-- Radio buttons to switch between Folders and Files -->
<label>
    <input type="radio" name="selectionType" value="folders" checked onchange="toggleSelectionType()"> Default
</label>
<label>
    <input type="radio" name="selectionType" value="files" onchange="toggleSelectionType()"> Custom
</label>
<br><br>

<!-- Folders Section -->
<div id="foldersSection">
    <label for="basePath">Base Path:</label>
    <input type="text" id="basePath" placeholder="Enter base path (e.g., /Users/jr5241/test/UnAligned/)" size="50%">
    <button type="button" onclick="listFolders()">List Folders</button>
</div>

<!-- Files Section -->
<div id="filesSection" style="display: none;">

    <label for="filebasePath">Base Path:</label>
    <input type="text" id="filebasePath" placeholder="Enter base path (e.g., /Users/jr5241/test/UnAligned/)" size="50%">
    <button type="button" onclick="Savefile()">Set Folder</button>

    <br>
    <label for="fileUpload">Upload File (CSV or TXT):</label>
    <input type="file" id="fileUpload" accept=".csv,.txt">
    <br>
    <button type="button" onclick="showHint()" style="margin-left: 10px;">Hint</button>
    <br>
            <!-- Hint Section -->
    <div id="hintSection" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9;">
              <pre>
      Format as below, either CSV or TXT file.
      Sample_name,read1,read2
      sampleS2_20252211_L001,sampleS2_20252211_L001_fastp_1.fastq,sampleS2_20252211_L001_fastp_2.fastq
      sampleS3_20252211_L001,sampleS3_20252211_L001_fastp_1.fastq,sampleS3_20252211_L001_fastp_2.fastq
      
              </pre>
          </div>
          <br>
          <button type="button" onclick="parseUploadedFile()">Parse File</button>
    </div>

 



<!-- Display Area -->
<div id="selectionCheckboxes"></div>
<div id="errorMessage" style="color: red; margin-top: 10px;"></div>
<br>
<button type="button" onclick="saveSelections()">Save Selections</button>
<span id="saveMessage" style="color: green; margin-left: 10px;"></span>

<br><br>

<h4>Workflow Selection</h4>
<p>================</p>


<h5>Select a YAML File</h5>

<select id="yamlDropdown" onchange="toggleYamlList()" style="width: 150px;">
  <option value="">-- Select YAML --</option>
  <option value="show">Show YAML Files</option>
</select>

<script>
    function Savefile() {
        const basePath = document.getElementById("filebasePath").value; 
        if (basePath.trim() === "") {
            alert("Please enter a valid folder path.");
            return;
        }
        console.log("Base Path saved:", basePath);
    }
</script>

<!-- #Download and upload yaml  -->

<form id="yamlForm">
    <div id="yamlFilesList"></div> <!-- This will hold the radio buttons -->
    <button type="button" onclick="downloadSelectedFile()">Download</button>
    <div id="errorContainer" style="color: red; display: none; margin-top: 5px;"></div> <!-- Error message here -->
    
    <br><br>

    <input type="file" id="yamlUpload" accept=".yml,.yaml">
    <button type="button" onclick="uploadYamlFile()">Upload</button>

    <p id="uploadError" style="color: red; display: none;"></p> <!-- Error message -->

</form>

<!-- Dropdown yaml  -->
<script>
 function toggleYamlList() {
    const yamlDropdown = document.getElementById('yamlDropdown');
    const yamlFilesList = document.getElementById('yamlFilesList');
    const selectedValue = yamlDropdown.value;

    if (selectedValue === 'show') {
        fetchYamlFiles();
        yamlFilesList.style.display = 'block';  // Show the YAML files list
    } else {
        yamlFilesList.style.display = 'none';  // Hide the YAML files list when not selected
    }
}

// Fetch yaml file as radio button from the plgins directory

function fetchYamlFiles() {
    fetch('/list_yaml_files')
        .then(response => response.json())
        .then(data => {
            const yamlFilesList = document.getElementById('yamlFilesList');
            yamlFilesList.innerHTML = ""; // Clear previous content

            if (data.yaml_files && data.yaml_files.length > 0) {
                data.yaml_files.forEach(file => {
                    const radioButton = document.createElement('input');
                    radioButton.type = 'radio';
                    radioButton.name = 'yamlFile';
                    radioButton.value = file;
                    radioButton.required = true;
                    
                    const label = document.createElement('label');
                    label.textContent = file;
                    
                    const br = document.createElement('br');

                    yamlFilesList.appendChild(radioButton);
                    yamlFilesList.appendChild(label);
                    yamlFilesList.appendChild(br);
                });
            } else {
                yamlFilesList.innerHTML = "<p>No YAML files found.</p>";
            }
        })
        .catch(error => {
            console.error('Error fetching YAML files:', error);
            document.getElementById('yamlFilesList').innerHTML = "<p>Error loading YAML files.</p>";
        });
}


    // Function to handle downloading the selected YAML file
    function downloadSelectedFile() {
        const selectedFile = document.querySelector('input[name="yamlFile"]:checked');
        const errorContainer = document.getElementById('errorContainer');

        if (!selectedFile) {
            errorContainer.textContent = "Please select a YAML file to download.";
            errorContainer.style.display = "block"; // Show error message
            return;
        }

        errorContainer.style.display = "none"; // Hide error if file is selected

        const filename = selectedFile.value;

        fetch('/download_yaml', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || "Download failed"); });
            }
            return response.blob();
        })
        .then(blob => {
            // Create a temporary link to trigger the file download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error("Error downloading file:", error);
            errorContainer.textContent = "Failed to download file: " + error.message;
            errorContainer.style.display = "block"; // Show error message
        });
    }


    function uploadYamlFile() {
    const fileInput = document.getElementById("yamlUpload");
    const uploadError = document.getElementById("uploadError");

    // Check if a file is selected
    if (!fileInput.files.length) {
        uploadError.textContent = "Please select a file to upload.";
        uploadError.style.display = "block";
        return;
    }

    const file = fileInput.files[0];
    // const basePath = document.getElementById('basePath').value; // Get base path value
    let basePath = "";
        if (document.getElementById("foldersSection").style.display !== "none") {
            basePath = document.getElementById('basePath').value; // Use the basePath from Folders section
        } else if (document.getElementById("filesSection").style.display !== "none") {
            basePath = document.getElementById('filebasePath').value; // Use the basePath from Files section
        }
        console.log("Selected Base Path: ", basePath);

    if (!basePath) {
        uploadError.textContent = "Please enter a base path before uploading.";
        uploadError.style.display = "block";
        return;
    }

    // Create FormData and append the file and base_path
    const formData = new FormData();
    formData.append("file", file);
    formData.append("base_path", basePath);  // Use the same basePath from the input field

    // Upload the YAML file to the /upload_yaml endpoint
    fetch('/upload_yaml', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            uploadError.textContent = result.error;
            uploadError.style.display = "block";
        } else {
            // const basePath = document.getElementById('basePath').value;
            uploadError.style.color = "green";
            uploadError.textContent = `Upload successful to path: ${basePath}`;
            uploadError.style.display = "block";
        }
    })
    .catch(error => {
        uploadError.textContent = "Upload failed. Try again.";
        uploadError.style.display = "block";
    });
}
</script>



<br>


<form method="POST" action="/rnaseqbaseview/">
  <input type="hidden" name="selected_items" id="selected_items_input">
  <button type="submit">Submit DAG</button>
</form>

<script>
function toggleSelectionType() {
    const foldersSection = document.getElementById('foldersSection');
    const filesSection = document.getElementById('filesSection');
    const selectionType = document.querySelector('input[name="selectionType"]:checked').value;

    if (selectionType === 'folders') {
        foldersSection.style.display = 'block';
        filesSection.style.display = 'none';
    } else {
        foldersSection.style.display = 'none';
        filesSection.style.display = 'block';
    }
}

async function listFolders() {
    const basePath = document.getElementById('basePath').value;
    const errorMessage = document.getElementById('errorMessage');
    const selectionCheckboxes = document.getElementById('selectionCheckboxes');

    errorMessage.textContent = '';
    selectionCheckboxes.innerHTML = '';

    if (!basePath) {
        errorMessage.textContent = 'Please enter a base path.';
        return;
    }
    console.log('Base path:', basePath);
    try {
        const response = await fetch('/listdir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ base_path: basePath }),
        });

        const result = await response.json();
        console.log(result);

        if (result.folder_names && result.folder_names.length > 0) {
            selectionCheckboxes.innerHTML += `
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                <label for="selectAll">Select All</label><br>
            `;

            result.folder_names.forEach((folder) => {
                selectionCheckboxes.innerHTML += `
                    <input type="checkbox" class="itemCheckbox" id="${folder}" name="selected_items" value="${folder}">
                    <label for="${folder}">${folder}</label><br>
                `;
            });
        } else {
            errorMessage.textContent = 'No folders found.';
        }
    } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = 'An error occurred while fetching folders.';
    }
}

async function parseUploadedFile() {
    const fileInput = document.getElementById('fileUpload');
    const errorMessage = document.getElementById('errorMessage');
    const selectionCheckboxes = document.getElementById('selectionCheckboxes');

    errorMessage.textContent = '';
    selectionCheckboxes.innerHTML = '';

    if (!fileInput.files || fileInput.files.length === 0) {
        errorMessage.textContent = 'Please select a file to upload.';
        return;
    }

    const file = fileInput.files[0];

    // Create a FormData object to send the file
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
        });

        const result = await response.json();
        console.log(result);

        if (result.sample_names && result.sample_names.length > 0) {
            selectionCheckboxes.innerHTML += `
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                <label for="selectAll">Select All</label><br>
            `;

            result.sample_names.forEach((sample) => {
                selectionCheckboxes.innerHTML += `
                    <input type="checkbox" class="itemCheckbox" id="${sample}" name="selected_items" value="${sample}">
                    <label for="${sample}">${sample}</label><br>
                `;
            });
        } else {
            errorMessage.textContent = 'No sample names found in the file.';
        }
    } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = 'An error occurred while parsing the file.';
    }
}

function toggleSelectAll(selectAllCheckbox) {
    const itemCheckboxes = document.querySelectorAll('.itemCheckbox');
    itemCheckboxes.forEach((checkbox) => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function saveSelections() {
    const selectedItems = Array.from(document.querySelectorAll('.itemCheckbox:checked'))
        .map((checkbox) => checkbox.value);

    if (selectedItems.length === 0) {
        saveMessage.style.color = 'red';
        saveMessage.textContent = 'Please select at least one item.';
        return;
    }

    const selectedItemsString = selectedItems.join(',');
    document.getElementById('selected_items_input').value = selectedItemsString;

    // Debug: Print selected items to the console
    console.log("Selected Items:", selectedItemsString);

    saveMessage.style.color = 'green';
    saveMessage.textContent = 'Selection saved successfully!';
}

function showHint() {
    const hintSection = document.getElementById('hintSection');
    if (hintSection.style.display === 'none') {
        hintSection.style.display = 'block';
    } else {
        hintSection.style.display = 'none';
    }
}

</script>

{% include 'appbuilder/flash.html' %}
{% endblock %}

{% block footer %}
  {% if not current_user.is_anonymous %}
    <footer class="footer">
      <div class="container">
        <div>
          Version: {% if airflow_version %}<a href="https://pypi.python.org/pypi/apache-airflow/{{ airflow_version }}" target="_blank">v{{ airflow_version }}</a>{% else %} N/A{% endif %}
          {% if git_version %}<br>Git Version: <strong>{{ git_version }}</strong>{% endif %}
        </div>
      </div>
    </footer>
  {% endif %}
{% endblock %}

{% block tail_js %}
  {{ super() }}
  <script>
    var Airflow = {
      serverTimezone: '{{ server_timezone }}',
      defaultUITimezone: '{{ default_ui_timezone }}',
    };
    var hostName = '{{ hostname }}';
    var csrfToken = '{{ csrf_token() }}';
    $('time[title]').tooltip();
  </script>
  <script src="{{ url_for_asset('moment.js') }}"></script>
  <script src="{{ url_for_asset('main.js') }}"></script>
  <script src="{{ url_for_asset('bootstrap-datetimepicker.min.js') }}"></script>
  <script src="{{ url_for_asset('bootstrap3-typeahead.min.js') }}"></script>
{% endblock %}